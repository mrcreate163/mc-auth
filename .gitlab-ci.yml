# GitLab CI/CD Pipeline –¥–ª—è Auth Microservice

# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: https://docs.gitlab.com/ee/ci/yaml/

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞–¥–∏–∏ –ø–∞–π–ø–ª–∞–π–Ω–∞
stages:
  - build
  - test
  - sonar      # ‚Üê –î–û–ë–ê–í–õ–ï–ù–ê –ù–û–í–ê–Ø –°–¢–ê–î–ò–Ø
  - package
  - deploy

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  # Docker Hub –æ–±—Ä–∞–∑ (—Ñ–æ—Ä–º–∞—Ç: username/repository)
  DOCKER_IMAGE: $DOCKER_HUB_USER/mc-auth
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA
  # SonarQube –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–î–û–ë–ê–í–õ–ï–ù–û)
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
  GIT_DEPTH: 0  # –í–∞–∂–Ω–æ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∫–æ–º–º–∏—Ç–æ–≤

# –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ Maven –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –º–µ–∂–¥—É –ø–∞–π–ø–ª–∞–π–Ω–∞–º–∏
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .m2/repository/
    - .sonar/cache  # ‚Üê –î–û–ë–ê–í–õ–ï–ù –ö–ï–® –î–õ–Ø SONARQUBE

# –ë–∞–∑–æ–≤—ã–π –æ–±—Ä–∞–∑ –¥–ª—è Java/Maven job'–æ–≤
.maven-job:
  image: maven:3.9.6-eclipse-temurin-21
  before_script:
    - echo "Maven version:" && mvn --version
    - echo "Java version:" && java --version

# ==================== BUILD STAGE ====================

build:
  extends: .maven-job
  stage: build
  script:
    - echo "üî® –ö–æ–º–ø–∏–ª—è—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞..."
    - mvn clean compile -DskipTests
  artifacts:
    paths:
      - target/classes/
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH == "develop"

# ==================== TEST STAGE ====================

unit-tests:
  extends: .maven-job
  stage: test
  script:
    - echo "üß™ –ó–∞–ø—É—Å–∫ unit-—Ç–µ—Å—Ç–æ–≤..."
    - mvn test -Dspring.profiles.active=test
  artifacts:
    when: always
    paths:
      - target/surefire-reports/
      - target/site/jacoco/  # –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è JaCoCo –æ—Ç—á—ë—Ç–æ–≤
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml
    expire_in: 1 week
  coverage: '/Total.*?([0-9]{1,3})%/'
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH == "develop"

integration-tests:
  extends: .maven-job
  stage: test
  services:
    - name: postgres:16
      alias: postgres
    - name: redis:7-alpine
      alias: redis
  variables:
    # PostgreSQL
    POSTGRES_DB: auth_test
    POSTGRES_USER: test
    POSTGRES_PASSWORD: test
    # Spring
    SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/auth_test
    SPRING_DATASOURCE_USERNAME: test
    SPRING_DATASOURCE_PASSWORD: test
    SPRING_REDIS_HOST: redis
    SPRING_PROFILES_ACTIVE: test
  script:
    - echo "üîó –ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤..."
    - mvn verify -DskipUnitTests -Dspring.profiles.active=test
  artifacts:
    when: always
    paths:
      - target/failsafe-reports/
    reports:
      junit:
        - target/failsafe-reports/TEST-*.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: true

# ==================== SONAR STAGE (–ù–û–í–ê–Ø –°–ï–ö–¶–ò–Ø) ====================

sonarqube-analysis:
  extends: .maven-job
  stage: sonar
  script:
    - echo "üîç –ó–∞–ø—É—Å–∫ SonarQube –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞..."
    - echo "SonarQube Server - ${SONAR_HOST_URL}"
    - echo "Project Key - ${SONAR_PROJECT_KEY}"
    - mvn clean verify sonar:sonar
      -Dsonar.projectKey=${SONAR_PROJECT_KEY}
      -Dsonar.projectName="${SONAR_PROJECT_NAME}"
      -Dsonar.host.url=${SONAR_HOST_URL}
      -Dsonar.token=${SONAR_TOKEN}
      -Dsonar.qualitygate.wait=true
      -Dsonar.java.binaries=target/classes
      -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
  allow_failure: false
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH == "develop"
  needs:
    - unit-tests
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# ==================== PACKAGE STAGE ====================

package-jar:
  extends: .maven-job
  stage: package
  script:
    - echo "üì¶ –°–±–æ—Ä–∫–∞ JAR —Ñ–∞–π–ª–∞..."
    - mvn package -DskipTests
    - echo "JAR —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω:"
    - ls -la target/*.jar
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH == "develop"

docker-build:
  stage: package
  image: docker:24
  variables:
    DOCKER_HOST: unix:///var/run/docker.sock
  before_script:
    - echo "üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Docker Hub..."
    - export DOCKER_HUB_USER=$(echo "$DOCKER_HUB_USER" | tr -d '\n\r ')
    - export DOCKER_HUB_TOKEN=$(echo "$DOCKER_HUB_TOKEN" | tr -d '\n\r')
    - export CLEAN_IMAGE="${DOCKER_HUB_USER}/mc-auth"
    - echo "$DOCKER_HUB_TOKEN" | docker login -u "$DOCKER_HUB_USER" --password-stdin
  script:
    - echo "üê≥ –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞..."
    - echo "Image - ${CLEAN_IMAGE}:${CI_COMMIT_SHORT_SHA}"
    - docker build -t "${CLEAN_IMAGE}:${CI_COMMIT_SHORT_SHA}" -t "${CLEAN_IMAGE}:latest" .
    - echo "üì§ Push –æ–±—Ä–∞–∑–∞ –≤ Docker Hub..."
    - docker push "${CLEAN_IMAGE}:${CI_COMMIT_SHORT_SHA}"
    - docker push "${CLEAN_IMAGE}:latest"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH == "develop"
  needs:
    - job: unit-tests
      artifacts: false
    - job: sonarqube-analysis  # ‚Üê –î–û–ë–ê–í–õ–ï–ù–ê –ó–ê–í–ò–°–ò–ú–û–°–¢–¨
      artifacts: false

# ==================== DEPLOY STAGE ====================

deploy-dev:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEV_SERVER_HOST >> ~/.ssh/known_hosts 2>/dev/null
    - export DOCKER_HUB_USER=$(echo "$DOCKER_HUB_USER" | tr -d '\n\r ')
    - export DEPLOY_IMAGE="${DOCKER_HUB_USER}/mc-auth:${CI_COMMIT_SHORT_SHA}"
  script:
    - echo "üöÄ –î–µ–ø–ª–æ–π –Ω–∞ DEV —Å–µ—Ä–≤–µ—Ä..."
    - echo "Deploying image - $DEPLOY_IMAGE"
    - |
      ssh $DEV_SERVER_USER@$DEV_SERVER_HOST << ENDSSH
      set -e
      echo "üì• Pulling image: $DEPLOY_IMAGE"
      docker pull $DEPLOY_IMAGE
      echo "üõë Stopping old container..."
      docker stop mc-auth || true
      docker rm mc-auth || true
      echo "üöÄ Starting new container with memory optimization..."
      docker run -d \
        --name mc-auth \
        --restart always \
        --network social-network-net \
        -p 8081:8081 \
        --memory=384m \
        --memory-reservation=256m \
        --cpus=1.0 \
        -e SPRING_PROFILES_ACTIVE=prod \
        -e JAVA_OPTS="-Xms128m -Xmx256m" \
        -e EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka \
        -e POSTGRES_PASSWORD=$POSTGRES_PASSWORD \
        -e REDIS_PASSWORD=$REDIS_PASSWORD \
        -e JWT_SECRET=$JWT_SECRET \
        $DEPLOY_IMAGE
      echo "üßπ Cleaning up dangling images..."
      docker image prune -f
      echo "üßπ Removing old mc-auth images, keep last 2..."
      docker images "mlz777/mc-auth" --format "{{.ID}} {{.CreatedAt}}" \
        | sort -k2,3 -r \
        | tail -n +3 \
        | awk '{print $1}' \
        | xargs -r docker rmi || true
      echo "‚úÖ DEV –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!"
      docker ps | grep mc-auth
      ENDSSH
  environment:
    name: development
    url: http://$DEV_SERVER_HOST:8081
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
      when: manual
  needs:
    - docker-build

deploy-prod:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEV_SERVER_HOST >> ~/.ssh/known_hosts 2>/dev/null
    - export DOCKER_HUB_USER=$(echo "$DOCKER_HUB_USER" | tr -d '\n\r ')
    - export DEPLOY_IMAGE="${DOCKER_HUB_USER}/mc-auth:${CI_COMMIT_SHORT_SHA}"
  script:
    - echo "üöÄ –î–µ–ø–ª–æ–π –Ω–∞ PRODUCTION —Å–µ—Ä–≤–µ—Ä..."
    - echo "Deploying image - $DEPLOY_IMAGE"
    - |
      ssh $DEV_SERVER_USER@$DEV_SERVER_HOST << ENDSSH
      set -e
      echo "üì• Pulling image: $DEPLOY_IMAGE"
      docker pull $DEPLOY_IMAGE
      echo "üõë Stopping old container..."
      docker stop mc-auth || true
      docker rm mc-auth || true
      echo "üöÄ Starting new container with memory optimization..."
      docker run -d \
        --name mc-auth \
        --restart always \
        --network social-network-net \
        -p 8081:8081 \
        --memory=384m \
        --memory-reservation=256m \
        --cpus=1.0 \
        -e SPRING_PROFILES_ACTIVE=prod \
        -e JAVA_OPTS="-Xms128m -Xmx256m" \
        -e EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka \
        $DEPLOY_IMAGE
      echo "üßπ Cleaning up dangling images..."
      docker image prune -f
      echo "üßπ Removing old mc-auth images, keep last 2..."
      docker images "mlz777/mc-auth" --format "{{.ID}} {{.CreatedAt}}" \
        | sort -k2,3 -r \
        | tail -n +3 \
        | awk '{print $1}' \
        | xargs -r docker rmi || true
      echo "‚úÖ Production –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!"
      docker ps | grep mc-auth
      ENDSSH
  environment:
    name: production
    url: http://$DEV_SERVER_HOST:8081
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  needs:
    - docker-build
    - unit-tests
    - sonarqube-analysis  # ‚Üê –î–û–ë–ê–í–õ–ï–ù–ê –ó–ê–í–ò–°–ò–ú–û–°–¢–¨
