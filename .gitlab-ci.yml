# GitLab CI/CD Pipeline –¥–ª—è Auth Microservice
# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: https://docs.gitlab.com/ee/ci/yaml/

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞–¥–∏–∏ –ø–∞–π–ø–ª–∞–π–Ω–∞
stages:
  - build
  - test
  - package
  - deploy

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  # Docker Hub –æ–±—Ä–∞–∑ (—Ñ–æ—Ä–º–∞—Ç: username/repository)
  DOCKER_IMAGE: $DOCKER_HUB_USER/mc-auth
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA

# –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ Maven –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –º–µ–∂–¥—É –ø–∞–π–ø–ª–∞–π–Ω–∞–º–∏
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .m2/repository/

# –ë–∞–∑–æ–≤—ã–π –æ–±—Ä–∞–∑ –¥–ª—è Java/Maven job'–æ–≤
.maven-job:
  image: maven:3.9.6-eclipse-temurin-21
  before_script:
    - echo "Maven version:" && mvn --version
    - echo "Java version:" && java --version

# ==================== BUILD STAGE ====================

build:
  extends: .maven-job
  stage: build
  script:
    - echo "üî® –ö–æ–º–ø–∏–ª—è—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞..."
    - mvn clean compile -DskipTests
  artifacts:
    paths:
      - target/classes/
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH == "develop"

# ==================== TEST STAGE ====================

unit-tests:
  extends: .maven-job
  stage: test
  script:
    - echo "üß™ –ó–∞–ø—É—Å–∫ unit-—Ç–µ—Å—Ç–æ–≤..."
    - mvn test -Dspring.profiles.active=test
  artifacts:
    when: always
    paths:
      - target/surefire-reports/
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml
    expire_in: 1 week
  coverage: '/Total.*?([0-9]{1,3})%/'
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH == "develop"

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
integration-tests:
  extends: .maven-job
  stage: test
  services:
    - name: postgres:16
      alias: postgres
    - name: redis:7-alpine
      alias: redis
  variables:
    # PostgreSQL
    POSTGRES_DB: auth_test
    POSTGRES_USER: test
    POSTGRES_PASSWORD: test
    # Spring
    SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/auth_test
    SPRING_DATASOURCE_USERNAME: test
    SPRING_DATASOURCE_PASSWORD: test
    SPRING_REDIS_HOST: redis
    SPRING_PROFILES_ACTIVE: test
  script:
    - echo "üîó –ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤..."
    - mvn verify -DskipUnitTests -Dspring.profiles.active=test
  artifacts:
    when: always
    paths:
      - target/failsafe-reports/
    reports:
      junit:
        - target/failsafe-reports/TEST-*.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: true  # –ú–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –∫–æ–≥–¥–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å—Ç–∞–±–∏–ª—å–Ω—ã

# ==================== PACKAGE STAGE ====================

# –°–±–æ—Ä–∫–∞ JAR –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
package-jar:
  extends: .maven-job
  stage: package
  script:
    - echo "üì¶ –°–±–æ—Ä–∫–∞ JAR —Ñ–∞–π–ª–∞..."
    - mvn package -DskipTests
    - echo "JAR —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω:"
    - ls -la target/*.jar
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH == "develop"

# –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç Docker socket —Ö–æ—Å—Ç–∞)
docker-build:
  stage: package
  image: docker:24
  variables:
    DOCKER_HOST: unix:///var/run/docker.sock
  before_script:
    - echo "üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Docker Hub..."
    # –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—Ç –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫
    - export DOCKER_HUB_USER=$(echo "$DOCKER_HUB_USER" | tr -d '\n\r ')
    - export DOCKER_HUB_TOKEN=$(echo "$DOCKER_HUB_TOKEN" | tr -d '\n\r')
    - export CLEAN_IMAGE="${DOCKER_HUB_USER}/mc-auth"
    - echo "$DOCKER_HUB_TOKEN" | docker login -u "$DOCKER_HUB_USER" --password-stdin
  script:
    - echo "üê≥ –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞..."
    - echo "Image - ${CLEAN_IMAGE}:${CI_COMMIT_SHORT_SHA}"
    - docker build -t "${CLEAN_IMAGE}:${CI_COMMIT_SHORT_SHA}" -t "${CLEAN_IMAGE}:latest" .
    - echo "üì§ Push –æ–±—Ä–∞–∑–∞ –≤ Docker Hub..."
    - docker push "${CLEAN_IMAGE}:${CI_COMMIT_SHORT_SHA}"
    - docker push "${CLEAN_IMAGE}:latest"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH == "develop"
  needs:
    - job: unit-tests
      artifacts: false

# ==================== DEPLOY STAGE ====================

# –î–µ–ø–ª–æ–π –Ω–∞ dev –æ–∫—Ä—É–∂–µ–Ω–∏–µ
deploy-dev:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEV_SERVER_HOST >> ~/.ssh/known_hosts 2>/dev/null
    # –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    - export DOCKER_HUB_USER=$(echo "$DOCKER_HUB_USER" | tr -d '\n\r ')
    - export DEPLOY_IMAGE="${DOCKER_HUB_USER}/mc-auth:${CI_COMMIT_SHORT_SHA}"
  script:
    - echo "üöÄ –î–µ–ø–ª–æ–π –Ω–∞ DEV —Å–µ—Ä–≤–µ—Ä..."
    - echo "Deploying image - $DEPLOY_IMAGE"
    - |
      ssh $DEV_SERVER_USER@$DEV_SERVER_HOST << ENDSSH
        set -e
        echo "üì• Pulling image: $DEPLOY_IMAGE"
        docker pull $DEPLOY_IMAGE
        
        echo "üõë Stopping old container..."
        docker stop mc-auth || true
        docker rm mc-auth || true
        
        echo "üöÄ Starting new container..."
        docker run -d \
          --name mc-auth \
          --restart always \
          --network social-network-net \
          -e SPRING_DATASOURCE_URL=jdbc:postgresql://localhost:5432/auth_db \
          -e SPRING_DATASOURCE_USERNAME=postgres \
          -e SPRING_DATASOURCE_PASSWORD=postgres \
          -e SPRING_REDIS_HOST=localhost \
          -e SPRING_PROFILES_ACTIVE=prod \
          $DEPLOY_IMAGE
        
        echo "üßπ Cleaning up old images..."
        docker image prune -f
        
        echo "‚úÖ DEV –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!"
        docker ps | grep mc-auth
      ENDSSH
  environment:
    name: development
    url: http://$DEV_SERVER_HOST:8081
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
      when: manual
  needs:
    - docker-build

# –î–µ–ø–ª–æ–π –Ω–∞ production
deploy-prod:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEV_SERVER_HOST >> ~/.ssh/known_hosts 2>/dev/null
    # –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    - export DOCKER_HUB_USER=$(echo "$DOCKER_HUB_USER" | tr -d '\n\r ')
    - export DEPLOY_IMAGE="${DOCKER_HUB_USER}/mc-auth:${CI_COMMIT_SHORT_SHA}"
  script:
    - echo "üöÄ –î–µ–ø–ª–æ–π –Ω–∞ PRODUCTION —Å–µ—Ä–≤–µ—Ä..."
    - echo "Deploying image - $DEPLOY_IMAGE"
    - |
      ssh $DEV_SERVER_USER@$DEV_SERVER_HOST << ENDSSH
        set -e
        echo "üì• Pulling image: $DEPLOY_IMAGE"
        docker pull $DEPLOY_IMAGE
        
        echo "üõë Stopping old container..."
        docker stop mc-auth || true
        docker rm mc-auth || true
        
        echo "üöÄ Starting new container..."
        docker run -d \
          --name mc-auth \
          --restart always \
          --network social-network-net \
          -e SPRING_DATASOURCE_URL=jdbc:postgresql://localhost:5432/auth_db \
          -e SPRING_DATASOURCE_USERNAME=postgres \
          -e SPRING_DATASOURCE_PASSWORD=postgres \
          -e SPRING_REDIS_HOST=localhost \
          -e SPRING_PROFILES_ACTIVE=prod \
          $DEPLOY_IMAGE
        
        echo "üßπ Cleaning up old images..."
        docker image prune -f
        
        echo "‚úÖ Production –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!"
        docker ps | grep mc-auth
      ENDSSH
  environment:
    name: production
    url: http://$DEV_SERVER_HOST:8081
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  needs:
    - docker-build
    - unit-tests

# ==================== OPTIONAL JOBS ====================

# –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
code-quality:
  extends: .maven-job
  stage: test
  script:
    - echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞..."
    - mvn checkstyle:check || true
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
dependency-check:
  extends: .maven-job
  stage: test
  script:
    - echo "üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö..."
    - mvn dependency-check:check || true
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual

